<script>
    const puzzles = [
      // ----------------------------------------------------
      // ⭐ STAGE 1 (인덱스 0): 제목 수정됨
      // ----------------------------------------------------
      {
        subtitle: "프롤로그. 사라진 시대의 잔향", // 제목 수정됨
        text: `고대 생명체가 사라진 시대
아주 오래전, 강촌 인근에는 지금은 기록에서 사라진 거대 비행 생명체가 존재했다는 전설만 흐릿하게 남아 있다. 현대 과학으로는 정체를 알 수 없는 생명체였고, 어느 순간 흔적 없이 사라졌다. 이 전설은 사실 여부도 불분명한 채 지역의 신화처럼만 전해진다.

**현대의 이상 현상 – 감응자의 등장**
최근 강촌 일대에서 '정체불명의 에너지 공진(Resonance)'이 급격히 증가한다. 레이더에는 주기적으로 신호가 찍히지만 기존 장비로는 분석되지 않는다. 그러던 중, 이 신호가 극소수의 인간에게만 감각적 자극을 주는 것이 발견된다. 그들은 감응자(Sensor)라 불린다. 

**중심에 놓인 물체 – 부화가 아닌 ‘각성’**
강촌 산속 특정 지점에서 알처럼 생긴 동그란 결정체(Artifact)가 발견된다. 따뜻하지도 차갑지도 않은 이 물체는 생체 반응도, 기계 반응도 아닌 독특한 파동을 내고 있다. 당초 학자들은 생명체의 알이라고 추측했으나, 이후 분석 결과 → ‘생명체적 신호’와 ‘지성적 패턴’이 동시에 존재하는, 정체불명의 유물이라는 결론이 내려진다.

이제, 감응자 중 한 명으로서 당신은 현장으로 파견된다.`, 
        answer: "시작",
        hint: "프롤로그를 모두 읽었다면 정답 칸에 '시작'이라고 입력해 주세요."
      },
      // ----------------------------------------------------
      // ⭐ STAGE 2 (인덱스 1): 새로 추가된 페이지 1 (내용 채움)
      // ----------------------------------------------------
      {
        subtitle: "프롤로그. 수첩을 줍다", // 새로 추가된 페이지
        text: `열차가 떠난 뒤, 잔열이 남은 바람이 플랫폼을 스치고 지나갔다. 
감응자로서 파견된 연구원, 당신은 배낭을 고쳐 매며 주변을 살폈다.
보고된 공진 신호는 모두 이곳, 강촌역을 중심으로 퍼져 나가고 있었다. 
당신은 특별한 장비 없이 자신의 감각에만 의존해야 하는 첫 파견 임무에 
익숙지 않은 긴장을 느끼고 있었다.

그때, 발치로 작은 그림자가 굴러왔다.
바람의 방향과도 맞지 않는, 설명하기 어려운 궤적이었다.
당신은 무심코 허리를 굽혀 그것을 주워 들었다.

**수첩.**
강촌의 지도를 닮은 듯한 특이한 표지, 손끝에 전해지는 미세한 떨림. 
마치 오랫동안 누군가를 기다려온 물건처럼 느껴졌다. 

당신은 천천히 첫 페이지를 펼쳤다.

**<이 수첩을 줍는 자, 공진을 느낄 뿐 아니라 들을 수 있다.>**
문장과 동시에,
귓속 깊은 곳에서 낮고 묵직한 파동이 울렸다. 
보고서에서 묘사되던 그 감각.
일반인은 느낄 수 없고, 감응자만이 들을 수 있다는 신호.

당신은 숨을 가볍게 삼켰다.
수첩은 그의 손에서 아주 기묘하게 떨리고 있었다. 
동시에 아티팩트 역시 공명했다.
마치 그가 오기를 알고 있었다는 듯이.

이 수첩을 집어든 순간, 이미 조사가 아니라,
**새로운 것이 시작되었다는 사실**을 불현듯 깨달았다.

공명은 자연스레 앞의 카페로 향했다.
당신은 그 공명을 따라, 카페로 향한다.

(바닥의 QR코드를 찍어 문제를 확인하세요.)`,
        answer: "코드입력", // 현장 정답으로 변경 필요
        hint: "QR코드를 찍고 얻은 정답을 입력하세요."
      },
      // ----------------------------------------------------
      // ⭐ STAGE 3 (인덱스 2): 장 번호 변경 (기존 2장 -> 1장)
      // ----------------------------------------------------
      {
        subtitle: "1장. 잔재 파동이 깨어나다", // 장 번호 변경 (기존 2장 -> 1장)
        text: `여기에 '1장' 시나리오 내용을 채워주세요. (기존 2장 내용)`,
        answer: "code2", // 기존 2장 정답 유지
        hint: "1장의 정답을 입력하세요."
      },
      // ----------------------------------------------------
      // ⭐ STAGE 4 (인덱스 3): 장 번호 변경 (기존 3장 -> 2장)
      // ----------------------------------------------------
      {
        subtitle: "2장. 첫문양이 깨어난 순간", // 장 번호 변경
        text: `여기에 시나리오 2장 내용을 채워주세요. (기존 3장 내용)`,
        answer: "code3",
        hint: "2장의 정답을 입력하세요."
      },
      // ----------------------------------------------------
      // ⭐ STAGE 5 (인덱스 4): 장 번호 변경 (기존 4장 -> 3장)
      // ----------------------------------------------------
      {
        subtitle: "3장. 공진의 첫폭발", // 장 번호 변경
        text: `여기에 시나리오 3장 내용을 채워주세요. (기존 4장 내용)`,
        answer: "code4",
        hint: "3장의 정답을 입력하세요."
      },
      // ----------------------------------------------------
      // ⭐ STAGE 6 (인덱스 5): 장 번호 변경 (기존 5장/6장 -> 4장/5장)
      // ----------------------------------------------------
      {
        subtitle: "4장. 고대생명체의 잔재흔적 / 5장. 문양언어의 등장", // 장 번호 변경
        text: `여기에 시나리오 4장 내용을 채워주세요. (기존 5장 내용)`,
        answer: "code5",
        hint: "4장 / 5장의 정답을 입력하세요."
      }
    ];

    const totalStages = puzzles.length;
    let currentStage = 0;

    const stageLabelEl    = document.getElementById("stageLabel");
    const stageSubtitleEl = document.getElementById("stageSubtitle"); // ⬅️ 이 부분을 수정했습니다.
    const storyTextEl     = document.getElementById("storyText");
    const messageEl       = document.getElementById("message");
    const hintEl          = document.getElementById("hint");
    const answerInputEl   = document.getElementById("answer");
    const submitBtnEl     = document.getElementById("submitBtn");
    const progressBarEl   = document.getElementById("progressBar");
    const progressTextEl  = document.getElementById("progressText");
    const answerAreaEl    = document.getElementById("answerArea");
    const clearBlockEl    = document.getElementById("clearBlock");
    const restartBtnEl    = document.getElementById("restartBtn");

    function normalize(text) {
      // 띄어쓰기를 없애고 소문자로 변환 (정확한 정답 처리를 위해)
      return text.trim().replace(/\s/g, '').toLowerCase();
    }

    function updateProgress() {
      const cleared = currentStage;
      const percent = (cleared / totalStages) * 100;
      progressBarEl.style.width    = percent + "%";
      progressTextEl.textContent   = `${cleared} / ${totalStages} CLEARED`;
      stageLabelEl.textContent     = `STAGE ${currentStage + 1} / ${totalStages}`;
    }

    function renderStage() {
      const p = puzzles[currentStage];

      // stageSubtitleEl이 null이 아니기 때문에 이제 정상 작동합니다.
      stageSubtitleEl.textContent = p.subtitle || "현장 로그를 읽고 코드를 입력하세요.";
      storyTextEl.innerHTML       = p.text || ""; 
      messageEl.textContent       = "";
      messageEl.className         = "message";

      answerInputEl.value    = "";
      answerInputEl.disabled = false;
      submitBtnEl.disabled   = false;
      answerAreaEl.style.display = "block";
      clearBlockEl.style.display = "none";
      
      // 힌트 강조 설정: 프롤로그 1, 2일 때 강조 스타일 적용
      if (currentStage === 0 || currentStage === 1) {
          hintEl.className = "hint active";
          hintEl.textContent = p.hint || "";
      } else {
          hintEl.className = "hint";
          hintEl.textContent = "힌트: " + (p.hint || "없음");
      }

      updateProgress();
      answerInputEl.focus();
    }

    function showClear() {
      progressBarEl.style.width   = "100%";
      progressTextEl.textContent  = `${totalStages} / ${totalStages} CLEARED`;
      stageLabelEl.textContent    = `STAGE ${totalStages} / ${totalStages}`;
      answerAreaEl.style.display  = "none";
      clearBlockEl.style.display  = "block";
    }

    function checkAnswer() {
      // 입력값을 띄어쓰기 없이 소문자로 변환
      const userAnswer = normalize(answerInputEl.value);
      const correct    = normalize(puzzles[currentStage].answer || "");

      if (!userAnswer) {
        messageEl.textContent = "정답(코드)을 입력해 주세요.";
        messageEl.className   = "message error";
        return;
      }

      if (userAnswer === correct) {
        messageEl.textContent = "기록 완료. 다음 장으로 넘어갑니다.";
        messageEl.className   = "message success";

        submitBtnEl.disabled   = true;
        answerInputEl.disabled = true;
        submitBtnEl.textContent = "✔ NEXT LOADING..."; // 버튼 텍스트 변경

        setTimeout(() => {
          submitBtnEl.textContent = "SUBMIT"; // 버튼 텍스트 복원
          if (currentStage >= totalStages - 1) {
            showClear();
          } else {
            currentStage += 1;
            renderStage();
          }
        }, 900);
      } else {
        messageEl.textContent = "코드가 일치하지 않습니다. 현장 기록을 다시 확인해 보세요.";
        messageEl.className   = "message error";
      }
    }

    submitBtnEl.addEventListener("click", checkAnswer);
    answerInputEl.addEventListener("keydown", (e) => {
      if (e.key === "Enter") checkAnswer();
    });

    if (restartBtnEl) {
      restartBtnEl.addEventListener("click", () => {
        currentStage = 0;
        renderStage();
      });
    }

    renderStage();
  </script>
